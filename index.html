<html>
<head>
	<title>Game 2D</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #000000;
		}
	</style>
	<script src="assets/scripts/pixi.js"></script>
	<script src="assets/scripts/jquery-1.10.2.min.js"></script>
	<script src="assets/scripts/tween/jquery.gsap.min.js"></script>
	<script src="assets/scripts/tween/TimelineLite.min.js"></script>
	<script src="assets/scripts/tween/TimelineMax.min.js"></script>
	<script src="assets/scripts/tween/TweenLite.min.js"></script>
	<script src="assets/scripts/tween/TweenMax.min.js"></script>
	<script src="assets/scripts/tween/easing/EasePack.min.js"></script>
	<script src="assets/scripts/stats.min.js"></script>
</head>
<body>
	<script>
		// GAME
		function Game() { }
		Game.stage = undefined;
		Game.renderer = undefined;
		Game.stageWidth = 900;
		Game.stageHeight = 600;
		Game.viewport = new PIXI.DisplayObjectContainer();
		Game.mapContainer = undefined;

		// Stats
		var stats = new Stats();
		stats.setMode(0); // 0: fps, 1: ms

		// Align top-left
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.left = '0px';
		stats.domElement.style.top = '0px';

		document.body.appendChild(stats.domElement);

		
		Game.initialize = function() {
			Game.stage = new PIXI.Stage(0x5996FF);
			Game.renderer = PIXI.autoDetectRenderer(Game.stageWidth, Game.stageHeight);
			document.body.appendChild(Game.renderer.view);

			PIXI.Texture.SCALE_MODE.DEFAULT = PIXI.Texture.SCALE_MODE.NEAREST;
			TweenLite.ticker.fps(60);
			//TweenLite.ticker.useRAF(false);

			// Add viewport to stage
			Game.stage.addChild(Game.viewport);

			requestAnimFrame(Game.animate);
		};

		Game.animate = function() {
			stats.begin();
			requestAnimFrame(Game.animate);

			// Execute update block
			Game.onUpdate();

			// Render the stage   
			Game.renderer.render(Game.stage);
			stats.end();
		};
		Game.onUpdate = function() { };

		// CAMERA
		function Camera() {
			this.position = new PIXI.Point(0, 0);

			this.centerAt = function(point) {
				this.position.x = (Game.stageWidth / 2) - point.x;
				this.position.y = (Game.stageHeight / 2) - point.y;
			}
			this.focus = function() {
				Game.viewport.position.x = this.position.x;
				Game.viewport.position.y = this.position.y;
			}
			this.smoothFocus = function() {
				var blurFilter = new PIXI.BlurFilter();
				blurFilter.blur = 0;
				Game.viewport.filters = [blurFilter];

				var t1 = new TimelineLite({
					// options
				}).to(Game.viewport.position, 1, {
					x: this.position.x,
					y: this.position.y,
					ease: Power3.easeInOut
				})
				var t2 = new TimelineLite({
					// options
				}).to(blurFilter, 0.5, {
					blur: 50,
					ease: Power3.easeIn
				}).to(blurFilter, 0.5, {
					blur: 0,
					ease: Power3.easeOut
				})
			}
		};

		// MAP
		function Map() { }
		Map.tilesets = undefined;
		Map.tiles = undefined;
		Map.tileWidth = undefined;
		Map.tileHeight = undefined;
		Map.tileScale = new PIXI.Point(2, 2);

		Map.load = function(url) {
			Game.mapContainer = new PIXI.DisplayObjectContainer();
			Game.mapContainer.alpha = 0;
			Game.viewport.addChild(Game.mapContainer);

			console.log('Loading map \'' + url + '\'...');
			$.getJSON(url, function(map) {
				// Tilesets loading
				Map.tilesets = new Object();
				Map.tiles = new Object();
				Map.tileWidth = map.tilewidth;
				Map.tileHeight = map.tileheight;

				$.each(map.tilesets, function(i, tileset) {
					console.log('\'' + tileset.name + '\' loaded.')
					Map.tilesets[tileset.name] = new PIXI.BaseTexture.fromImage(tileset.image);
					
					var img_width = tileset.imagewidth + (tileset.margin * 2);
					var img_height = tileset.imageheight + (tileset.margin * 2);
					var tile_width = tileset.tilewidth + (tileset.spacing * 2);
					var tile_height = tileset.tileheight + (tileset.spacing * 2);
					var width = img_width / tile_width;
					var height = img_height / tile_height;
					var count = width * height;

					var x = 0, y = 0;
					var gid = tileset.firstgid;
					for (var i = 0; i < count; i++) {
						Map.tiles[gid] = new PIXI.Texture(Map.tilesets[tileset.name], new PIXI.Rectangle(tileset.margin + (x * tileset.tilewidth), tileset.margin + (y * tileset.tileheight), tileset.tilewidth, tileset.tileheight));
						x++;
						if((i+1) % width == 0) {
							x = 0;
							y++;
						}
						gid++;
					};

					//console.log(img_width + 'x' + img_height);
					//console.log(tile_width + 'x' + tile_height);
					//console.log(width + 'x' + height);
					//console.log(count);
				});

				// Drawing
				$.each(map.layers, function(i, layer) {
					console.log('Drawing \'' + layer.name + '\'...')

					if(layer.visible == true) {
						switch(layer.type) {
							case 'tilelayer':
								var x = layer.x * Map.tileWidth * Map.tileScale.x, y = layer.y * Map.tileHeight * Map.tileScale.y;
								$.each(layer.data, function(i, tile) {
									if(tile != 0) {
										var tile = new PIXI.Sprite(Map.tiles[tile]);
										tile.scale = Map.tileScale;
										tile.position = new PIXI.Point(x * Map.tileWidth * Map.tileScale.x, y * Map.tileHeight * Map.tileScale.y);
										Game.mapContainer.addChild(tile);
									}
									x++;
									if((i+1) % layer.width == 0) {
										y++;
										x = 0;
									}
								});
							break;
						}
					}
					console.log("Done.");
				});
			}).done(function(){
				console.log('Finished.');

				var tl = new TimelineLite({					
					onComplete: callback
				}).to(Game.mapContainer, 1, {
					alpha: 1,
					ease: Linear.easeNone
				});

				function callback() {
					console.log("Animation finished.");
				}
			});
		};

		Map.clear = function() {
			if(Game.mapContainer != undefined){
				Game.stage.removeChild(Game.mapContainer);
				Game.mapContainer = undefined;
				console.log("Map cleaned.")
			}
		};


		Game.initialize();
		Map.load('assets/maps/test-1.json');

		var camera1 = new Camera();
		camera1.centerAt(new PIXI.Point(500, 500));

		var camera2 = new Camera();
		camera2.centerAt(new PIXI.Point(1600, 1600));

		Game.onUpdate = function() {
			//console.log('frame');
		}
	</script>
	</body>
</html>